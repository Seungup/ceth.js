{"mappings":";;;;;;;MEGqB,wCAAe;iBAGb,CAAC;QACtB,IAAI,CAAC,iBAAiB,GAAG,GAAG,CAAC,wBAAiB;IAC/C,CAAC;IAED,SAAS,GAAsB,CAAC;QAC/B,MAAM,CAAC,IAAI,CAAC,iBAAiB;IAC9B,CAAC;WAEM,WAAW,GAAG,CAAC;QACrB,MAAM,CAAC,IAAI,CAAC,QAAQ,KAAK,IAAI,CAAC,QAAQ,GAAG,GAAG,CAAC,IAAI;IAClD,CAAC;;;;MDCW,yCAAgB;gBAIlB,KAAK,GAAG,GAAG,CAAC,YAAW,IACf,eAAe,GAAG,wCAAe,CAAC,WAAW,GAC7D,CAAC;aAFO,KAAK,GAAL,KAAK;aACG,eAAe,GAAf,eAAe;QAEhC,IAAI,CAAC,MAAM,GAAG,IAAI,CAAC,eAAe,CAAC,SAAS;IAC7C,CAAC;WAEM,WAAW,GAAG,CAAC;QACrB,MAAM,CAAC,IAAI,CAAC,QAAQ,KAAK,IAAI,CAAC,QAAQ,GAAG,GAAG,CAAC,IAAI;IAClD,CAAC;IAED,aAAa,CAAC,KAAa,EAAW,CAAC;QACtC,GAAG,CAAC,OAAO,GAAG,KAAK;QACnB,EAAE,EAAE,IAAI,CAAC,QAAQ,EAAE,CAAC;YACnB,IAAI,CAAC,QAAQ,CAAC,aAAa,CAAC,KAAK;YACjC,OAAO,GAAG,IAAI;QACf,CAAC;QACD,MAAM,CAAC,OAAO;IACf,CAAC;IAGD,IAAI,CAAC,MAAyB,EAAE,CAAC;QAChC,KAAK,CAAC,MAAM,GAA4B,CAAC;YACxC,MAAM,EAAE,MAAM;YACd,eAAe,EAAE,CAAkB;YACnC,KAAK,EAAE,IAAI;YACX,SAAS,EAAE,IAAI;YACf,sBAAsB,EAAE,IAAI;YAC5B,KAAK,EAAE,KAAK;QACb,CAAC;QAED,KAAK,CAAC,OAAO,GAAG,MAAM,CAAC,UAAU,CAAC,CAAQ;QAC1C,EAAE,EAAE,OAAO,EACV,MAAM,CAAC,OAAO,GAAG,OAAO;QAGzB,IAAI,CAAC,QAAQ,GAAG,GAAG,CAAC,oBAAmB,CAAC,MAAM;QAC9C,OAAO,CAAC,GAAG,EACT,4BAA4B,EAAE,IAAI,CAAC,QAAQ,CAAC,YAAY,CAAC,QAAQ;IAEpE,CAAC;IAED,OAAO,CAAC,KAAa,EAAE,MAAc,EAAE,CAAC;QACvC,KAAK,CAAC,MAAM,GAAG,IAAI,CAAC,eAAe,CAAC,SAAS;QAC7C,MAAM,CAAC,MAAM,GAAG,KAAK,GAAG,MAAM;QAC9B,MAAM,CAAC,sBAAsB;QAC7B,IAAI,CAAC,QAAQ,EAAE,OAAO,CAAC,KAAK,EAAE,MAAM,EAAE,KAAK;IAC5C,CAAC;IAED,EAGG,AAHH,0DAGG,AAHH,EAGG,CACH,MAAM,CAAC,KAAkB,EAAE,CAAC;QAC3B,EAAE,EAAE,IAAI,CAAC,QAAQ,EAAE,CAAC;YACnB,IAAI,CAAC,MAAM,CAAC,gBAAgB,GAAG,KAAK;YAEpC,EAAkB,AAAlB,gBAAkB;YAClB,IAAI,CAAC,MAAM,CAAC,WAAW,CAAC,GAAG,CAC1B,KAAK,CAAC,IAAI,CAAE,CAAC,GAAG,KAAK,CAAC,IAAI,CAAE,CAAC,GAAG,KAAK,CAAC,IAAI,CAAE,CAAC,GAAG,KAAK,CAAC,IAAI,CAAC,EAAE,GAC7D,KAAK,CAAC,IAAI,CAAE,CAAC,GAAG,KAAK,CAAC,IAAI,CAAE,CAAC,GAAG,KAAK,CAAC,IAAI,CAAE,CAAC,GAAG,KAAK,CAAC,IAAI,CAAC,EAAE,GAC7D,KAAK,CAAC,IAAI,CAAE,CAAC,GAAG,KAAK,CAAC,IAAI,CAAE,CAAC,GAAG,KAAK,CAAC,IAAI,CAAC,EAAE,GAAG,KAAK,CAAC,IAAI,CAAC,EAAE,GAC7D,KAAK,CAAC,IAAI,CAAE,CAAC,GAAG,KAAK,CAAC,IAAI,CAAE,CAAC,GAAG,KAAK,CAAC,IAAI,CAAC,EAAE,GAAG,KAAK,CAAC,IAAI,CAAC,EAAE;YAE9D,EAAkB,AAAlB,gBAAkB;YAClB,IAAI,CAAC,MAAM,CAAC,kBAAkB,CAAC,GAAG,CACjC,KAAK,CAAC,GAAG,CAAE,CAAC,GAAG,KAAK,CAAC,GAAG,CAAE,CAAC,GAAG,KAAK,CAAC,GAAG,CAAE,CAAC,GAAG,KAAK,CAAC,GAAG,CAAC,EAAE,GACzD,KAAK,CAAC,GAAG,CAAE,CAAC,GAAG,KAAK,CAAC,GAAG,CAAE,CAAC,GAAG,KAAK,CAAC,GAAG,CAAE,CAAC,GAAG,KAAK,CAAC,GAAG,CAAC,EAAE,GACzD,KAAK,CAAC,GAAG,CAAE,CAAC,GAAG,KAAK,CAAC,GAAG,CAAE,CAAC,GAAG,KAAK,CAAC,GAAG,CAAC,EAAE,GAAG,KAAK,CAAC,GAAG,CAAC,EAAE,GACzD,KAAK,CAAC,GAAG,CAAE,CAAC,GAAG,KAAK,CAAC,GAAG,CAAE,CAAC,GAAG,KAAK,CAAC,GAAG,CAAC,EAAE,GAAG,KAAK,CAAC,GAAG,CAAC,EAAE;YAG1D,IAAI,CAAC,MAAM,CAAC,sBAAsB;YAElC,IAAI,CAAC,QAAQ,CAAC,MAAM,CAAC,IAAI,CAAC,KAAK,EAAE,IAAI,CAAC,MAAM;QAC7C,CAAC;IACF,CAAC;;;;;;;;;;;ME1FW,yCAAW;IAUvB,EAEG,AAFH,yCAEG,AAFH,EAEG,CACK,yBAAyB,GAAG,CAAC;QACpC,IAAI,CAAC,KAAK,GAAG,IAAI,CAAC,MAAM,CAAC,GAAG;QAC5B,EAAE,EAAE,IAAI,CAAC,KAAK,EACb,IAAI,CAAC,OAAO,CAAC,MAAM,CAAC,IAAI,CAAC,KAAK;QAE/B,IAAI,CAAC,OAAO,GAAG,qBAAqB,CACnC,IAAI,CAAC,6BAA6B;QAEnC,IAAI,CAAC,cAAc,CAAC,IAAI;IACzB,CAAC;IAED,EAGG,AAHH,qFAGG,AAHH,EAGG,CACH,wBAAwB,CAAC,KAAkB,EAAE,CAAC;QAC7C,EAAE,EAAE,IAAI,CAAC,MAAM,CAAC,MAAM,EACrB,IAAI,CAAC,MAAM,CAAC,CAAC,IAAI,KAAK;aAEtB,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,KAAK;QAGvB,EAAE,GAAG,IAAI,CAAC,OAAO,EAAE,IAAI,CAAC,yBAAyB;IAClD,CAAC;;QApCK,IAqCN,CApCiB,MAAM,GAAkB,CAAC,CAAC;QADrC,IAqCN,CAnCiB,OAAO,GAAG,0DAAgB,CAAC,WAAW;QAFjD,IAqCN,CAhCiB,6BAA6B,GAC7C,IAAI,CAAC,yBAAyB,CAAC,IAAI,CAAC,IAAI;QANnC,IAqCN,CA9BiB,cAAc,GAAG,GAAG,CAAC,0DAAO;QAPvC,IAqCN,CA7BS,gBAAgB,GAAG,IAAI,CAAC,cAAc,CAAC,IAAI;;;;;;;;;;MHAhC,wCAAU;iBAKhB,CAAC;QALD,IAsJd,CArJiB,OAAO,GAAG,GAAG,CAAC,GAAG;QADpB,IAsJd,CApJiB,gBAAgB,GAAG,yCAAgB,CAAC,WAAW;QAFlD,IAsJd,CAnJiB,YAAY,GAAG,GAAG,CAAC,mBAAY;QAHlC,IAsJd,CAlJQ,YAAY,GAAG,GAAG,CAAC,yCAAW;QAErC,IAAI,CAAC,YAAY,CAAC,gBAAgB,CAAC,SAAS,KAAO,CAAC;YACnD,IAAI,CAAC,WAAW,CAAC,CAAC;gBAAC,IAAI,EAAE,CAAU;YAAC,CAAC;QACtC,CAAC;QACD,IAAI,CAAC,SAAS,IAAI,CAAe,GAAK,CAAC;YACtC,KAAK,CAAC,OAAO,GAAG,CAAC,CAAC,IAAI;YACtB,EAAE,EAAE,OAAO,EACV,MAAM,CAAE,OAAO,CAAC,IAAI;gBACnB,IAAI,CAAC,yCAAW,CAAC,MAAM;oBACtB,IAAI,CAAC,YAAY,CAAC,wBAAwB,CAAC,CAAC;2BACxC,OAAO,CAAC,KAAK;oBACjB,CAAC;oBACD,KAAK;;oBAEL,KAAK;;QAGT,CAAC;IACF,CAAC;IAED,IAAI,CAAC,MAAyB,EAAE,CAAC;QAChC,IAAI,CAAC,gBAAgB,CAAC,IAAI,CAAC,MAAM;IAClC,CAAC;IAED,aAAa,CAAC,KAAa,EAAE,CAAC;QAC7B,IAAI,CAAC,gBAAgB,CAAC,aAAa,CAAC,KAAK;IAC1C,CAAC;IAED,OAAO,CAAC,EAAU,EAAuB,CAAC;QACzC,KAAK,CAAC,MAAM,GAAG,IAAI,CAAC,SAAS,CAAC,EAAE;QAChC,EAAE,EAAE,MAAM,EACT,MAAM,CAAC,MAAM,CAAC,QAAQ,CAAC,IAAI;IAE7B,CAAC;IAED,aAAa,CAAI,EAAU,EAAE,GAAW,EAAE,CAAC;QAC1C,KAAK,CAAC,MAAM,GAAG,IAAI,CAAC,SAAS,CAAC,EAAE;QAChC,EAAE,EAAE,MAAM,EACT,MAAM,CAAI,MAAM,CAAC,QAAQ,CAAC,GAAG;IAE/B,CAAC;IAED,aAAa,CAAC,EAAU,EAAE,GAAW,EAAE,IAAS,EAAE,CAAC;QAClD,KAAK,CAAC,MAAM,GAAG,IAAI,CAAC,SAAS,CAAC,EAAE;QAChC,EAAE,EAAE,MAAM,EACT,MAAM,CAAC,QAAQ,CAAC,GAAG,IAAI,IAAI;IAE7B,CAAC;IAEO,SAAS,CAAC,KAAa,EAAE,CAAC;QACjC,MAAM,CAAC,IAAI,CAAC,gBAAgB,CAAC,KAAK,CAAC,aAAa,CAAC,KAAK;IACvD,CAAC;IAED,OAAO,CAAC,EAAU,EAAE,CAAC;QACpB,MAAM,GAAG,IAAI,CAAC,SAAS,CAAC,EAAE;IAC3B,CAAC;IAED,cAAc,CAAC,EAAU,EAAE,CAAC;QAC3B,KAAK,CAAC,MAAM,GAAG,IAAI,CAAC,SAAS,CAAC,EAAE;QAChC,EAAE,EAAE,MAAM;YACT,EAAE,EAAE,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,CAAW,aAAG,CAAC;gBACnC,KAAK,CAAC,MAAM,GAAG,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,CAAW;gBAC3C,MAAM,CAAC,MAAM,CAAC,MAAM;YACrB,CAAC,MAAM,CAAC;gBACP,KAAK,CAAC,MAAM,GAAG,GAAG,CAAC,gBAAS,CAAC,MAAM;gBACnC,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,CAAW,YAAE,MAAM;gBACpC,IAAI,CAAC,gBAAgB,CAAC,KAAK,CAAC,GAAG,CAAC,MAAM;YACvC,CAAC;;IAEH,CAAC;IAED,IAAI,CAAC,EAAU,EAAE,CAAC;QACjB,KAAK,CAAC,MAAM,GAAG,IAAI,CAAC,SAAS,CAAC,EAAE;QAChC,EAAE,EAAE,MAAM,EACT,MAAM,CAAC,OAAO,GAAG,KAAK;QAEvB,MAAM,GAAG,MAAM;IAChB,CAAC;IAED,IAAI,CAAC,EAAU,EAAE,CAAC;QACjB,KAAK,CAAC,MAAM,GAAG,IAAI,CAAC,SAAS,CAAC,EAAE;QAChC,EAAE,EAAE,MAAM,EACT,MAAM,CAAC,OAAO,GAAG,IAAI;QAEtB,MAAM,GAAG,MAAM;IAChB,CAAC;IAED,GAAG,CAAC,IAAS,EAAE,CAAC;QACf,KAAK,CAAC,MAAM,GAAG,IAAI,CAAC,YAAY,CAAC,KAAK,CAAC,IAAI;QAC3C,IAAI,CAAC,gBAAgB,CAAC,KAAK,CAAC,GAAG,CAAC,MAAM;QACtC,MAAM,CAAC,MAAM,CAAC,EAAE;IACjB,CAAC;IAED,MAAM,CAAC,EAAU,EAAE,IAAS,EAAE,CAAC;QAC9B,GAAG,CAAC,MAAM,GAAG,IAAI,CAAC,SAAS,CAAC,EAAE;QAC9B,EAAE,EAAE,MAAM,EAAE,CAAC;YACZ,KAAK,CAAC,YAAY,GAAG,IAAI,CAAC,YAAY,CAAC,KAAK,CAAC,IAAI;YACjD,MAAM,CAAC,IAAI,CAAC,YAAY;QACzB,CAAC;QACD,MAAM,GAAG,MAAM;IAChB,CAAC;IAED,QAAQ,CAAC,EAAU,EAAE,CAAC;QACrB,KAAK,CAAC,MAAM,GAAG,IAAI,CAAC,SAAS,CAAC,EAAE;QAChC,EAAE,EAAE,MAAM,EACT,MAAM,CAAC,MAAM,CAAC,QAAQ,CAAC,KAAK;IAE9B,CAAC;IAED,OAAO,CAAC,KAAa,EAAE,MAAc,EAAE,CAAC;QACvC,yCAAgB,CAAC,WAAW,GAAG,OAAO,CAAC,KAAK,EAAE,MAAM;IACrD,CAAC;IAED,UAAU,CAAC,KAAsB,EAAE,CAAC;QACnC,KAAK,CAAC,MAAM,GAAG,wCAAe,CAAC,WAAW,GAAG,SAAS;QACtD,MAAM,CAAC,MAAM,GAAG,KAAK,CAAC,MAAM;QAC5B,MAAM,CAAC,GAAG,GAAG,KAAK,CAAC,GAAG;QACtB,MAAM,CAAC,IAAI,GAAG,KAAK,CAAC,IAAI;QACxB,MAAM,CAAC,GAAG,GAAG,KAAK,CAAC,GAAG;QACtB,OAAO,CAAC,KAAK,CAAC,KAAK;QACnB,MAAM,CAAC,sBAAsB;IAC9B,CAAC;IAED,cAAc,CACb,EAAU,EACV,KAGC,EACA,CAAC;QACF,GAAG,CAAC,MAAM,GAAG,IAAI,CAAC,SAAS,CAAC,EAAE;QAC9B,EAAE,EAAE,MAAM,EAAE,CAAC;YACZ,MAAM,CAAC,YAAY,CAAC,KAAK,CAAC,MAAM;YAChC,MAAM,CAAC,QAAQ,CAAC,KAAK,GAAG,KAAK,CAAC,QAAQ;QACvC,CAAC;QACD,MAAM,GAAG,MAAM;IAChB,CAAC;IAED,MAAM,CAAC,EAAU,EAAE,CAAC;QACnB,KAAK,CAAC,MAAM,GAAG,IAAI,CAAC,SAAS,CAAC,EAAE;QAChC,EAAE,EAAE,MAAM,EACT,IAAI,CAAC,gBAAgB,CAAC,KAAK,CAAC,MAAM,CAAC,MAAM;QAE1C,MAAM,GAAG,MAAM;IAChB,CAAC;;AAGK,KAAK,CAAC,yCAAW,GAAG,MAAM,CAAC,MAAM,CAAC,CAAC;IACzC,MAAM,EAAE,CAAC;AACV,CAAC;AAED,aAAM,CAAC,GAAG,CAAC,wCAAU","sources":["src/core/core-thread.ts","src/core/graphic/graphic.component.ts","src/core/camera/camera.component.ts","src/core/render.queue.ts"],"sourcesContent":["import { expose } from 'comlink';\r\nimport { GraphicComponent } from './graphic/graphic.component';\r\nimport { BoxHelper, Matrix4, Object3D, ObjectLoader, Vector3 } from 'three';\r\nimport { ThreeWGS84 } from '..';\r\nimport CameraComponent from './camera/camera.component';\r\nimport { RenderQueue } from './render.queue';\r\n\r\nexport interface CameraInitParam {\r\n\taspect: number;\r\n\tfar: number;\r\n\tnear: number;\r\n\tfov: number;\r\n}\r\n\r\nexport default class CoreThread {\r\n\tprivate readonly helpers = new Map<string, Object3D>();\r\n\tprivate readonly graphicComponent = GraphicComponent.getInstance();\r\n\tprivate readonly objectLoader = new ObjectLoader();\r\n\tprivate _renderQueue = new RenderQueue();\r\n\tconstructor() {\r\n\t\tthis._renderQueue.renderNextFrame$.subscribe(() => {\r\n\t\t\tself.postMessage({ type: 'onRender' });\r\n\t\t});\r\n\t\tself.onmessage = (e: MessageEvent) => {\r\n\t\t\tconst message = e.data;\r\n\t\t\tif (message) {\r\n\t\t\t\tswitch (message.type) {\r\n\t\t\t\t\tcase RequestType.RENDER:\r\n\t\t\t\t\t\tthis._renderQueue.updateNextAnimationFrame({\r\n\t\t\t\t\t\t\t...message.param,\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tdefault:\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t};\r\n\t}\r\n\r\n\tinit(canvas: HTMLCanvasElement) {\r\n\t\tthis.graphicComponent.init(canvas);\r\n\t}\r\n\r\n\tsetPixelRatio(value: number) {\r\n\t\tthis.graphicComponent.setPixelRatio(value);\r\n\t}\r\n\r\n\tgetBox3(id: number): Vector3 | undefined {\r\n\t\tconst object = this.getObject(id);\r\n\t\tif (object) {\r\n\t\t\treturn object.userData.box3;\r\n\t\t}\r\n\t}\r\n\r\n\tgetUserDataAt<T>(id: number, key: string) {\r\n\t\tconst object = this.getObject(id);\r\n\t\tif (object) {\r\n\t\t\treturn <T>object.userData[key];\r\n\t\t}\r\n\t}\r\n\r\n\tsetUserDataAt(id: number, key: string, data: any) {\r\n\t\tconst object = this.getObject(id);\r\n\t\tif (object) {\r\n\t\t\tobject.userData[key] = data;\r\n\t\t}\r\n\t}\r\n\r\n\tprivate getObject(value: number) {\r\n\t\treturn this.graphicComponent.scene.getObjectById(value);\r\n\t}\r\n\r\n\tisExist(id: number) {\r\n\t\treturn !!this.getObject(id);\r\n\t}\r\n\r\n\tsetBoxHelperTo(id: number) {\r\n\t\tconst object = this.getObject(id);\r\n\t\tif (object) {\r\n\t\t\tif (this.helpers.has('BoxHelper')) {\r\n\t\t\t\tconst helper = this.helpers.get('BoxHelper')! as BoxHelper;\r\n\t\t\t\thelper.update(object);\r\n\t\t\t} else {\r\n\t\t\t\tconst helper = new BoxHelper(object);\r\n\t\t\t\tthis.helpers.set('BoxHelper', helper);\r\n\t\t\t\tthis.graphicComponent.scene.add(helper);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\thide(id: number) {\r\n\t\tconst object = this.getObject(id);\r\n\t\tif (object) {\r\n\t\t\tobject.visible = false;\r\n\t\t}\r\n\t\treturn !!object;\r\n\t}\r\n\r\n\tshow(id: number) {\r\n\t\tconst object = this.getObject(id);\r\n\t\tif (object) {\r\n\t\t\tobject.visible = true;\r\n\t\t}\r\n\t\treturn !!object;\r\n\t}\r\n\r\n\tadd(json: any) {\r\n\t\tconst object = this.objectLoader.parse(json);\r\n\t\tthis.graphicComponent.scene.add(object);\r\n\t\treturn object.id;\r\n\t}\r\n\r\n\tupdate(id: number, json: any) {\r\n\t\tlet object = this.getObject(id);\r\n\t\tif (object) {\r\n\t\t\tconst updateObject = this.objectLoader.parse(json);\r\n\t\t\tobject.copy(updateObject);\r\n\t\t}\r\n\t\treturn !!object;\r\n\t}\r\n\r\n\tgetWGS84(id: number) {\r\n\t\tconst object = this.getObject(id);\r\n\t\tif (object) {\r\n\t\t\treturn object.userData.wgs84 as ThreeWGS84;\r\n\t\t}\r\n\t}\r\n\r\n\tsetSize(width: number, height: number) {\r\n\t\tGraphicComponent.getInstance().setSize(width, height);\r\n\t}\r\n\r\n\tinitCamera(param: CameraInitParam) {\r\n\t\tconst camera = CameraComponent.getInstance().getCamera();\r\n\t\tcamera.aspect = param.aspect;\r\n\t\tcamera.far = param.far;\r\n\t\tcamera.near = param.near;\r\n\t\tcamera.fov = param.fov;\r\n\t\tconsole.table(param);\r\n\t\tcamera.updateProjectionMatrix();\r\n\t}\r\n\r\n\tupdatePosition(\r\n\t\tid: number,\r\n\t\tparam: {\r\n\t\t\tmatrix: Matrix4;\r\n\t\t\tposition: ThreeWGS84;\r\n\t\t}\r\n\t) {\r\n\t\tlet object = this.getObject(id);\r\n\t\tif (object) {\r\n\t\t\tobject.applyMatrix4(param.matrix);\r\n\t\t\tobject.userData.wgs84 = param.position;\r\n\t\t}\r\n\t\treturn !!object;\r\n\t}\r\n\r\n\tdelete(id: number) {\r\n\t\tconst object = this.getObject(id);\r\n\t\tif (object) {\r\n\t\t\tthis.graphicComponent.scene.remove(object);\r\n\t\t}\r\n\t\treturn !!object;\r\n\t}\r\n}\r\n\r\nexport const RequestType = Object.freeze({\r\n\tRENDER: 0,\r\n});\r\n\r\nexpose(new CoreThread());\r\n","import * as THREE from 'three';\r\nimport CameraComponent from '../camera/camera.component';\r\nimport { Matrix4, Vector3, WebGLRendererParameters } from 'three';\r\n\r\nexport interface CurrentExtent {\r\n\txmin: number;\r\n\tymin: number;\r\n\txmax: number;\r\n\tymax: number;\r\n\theight: number;\r\n}\r\n\r\nexport interface RenderParam {\r\n\tcvm: Float32Array;\r\n\tcivm: Float32Array;\r\n}\r\n\r\nexport class GraphicComponent {\r\n\tprivate static instance: GraphicComponent;\r\n\tprivate readonly camera: THREE.PerspectiveCamera;\r\n\tprivate constructor(\r\n\t\treadonly scene = new THREE.Scene(),\r\n\t\tprivate readonly cameraComponent = CameraComponent.getInstance()\r\n\t) {\r\n\t\tthis.camera = this.cameraComponent.getCamera();\r\n\t}\r\n\r\n\tstatic getInstance() {\r\n\t\treturn this.instance || (this.instance = new this());\r\n\t}\r\n\r\n\tsetPixelRatio(value: number): boolean {\r\n\t\tlet success = false;\r\n\t\tif (this.renderer) {\r\n\t\t\tthis.renderer.setPixelRatio(value);\r\n\t\t\tsuccess = true;\r\n\t\t}\r\n\t\treturn success;\r\n\t}\r\n\r\n\trenderer?: THREE.WebGLRenderer;\r\n\tinit(canvas: HTMLCanvasElement) {\r\n\t\tconst params: WebGLRendererParameters = {\r\n\t\t\tcanvas: canvas,\r\n\t\t\tpowerPreference: 'high-performance',\r\n\t\t\talpha: true,\r\n\t\t\tantialias: true,\r\n\t\t\tlogarithmicDepthBuffer: true,\r\n\t\t\tdepth: false,\r\n\t\t};\r\n\r\n\t\tconst context = canvas.getContext('webgl2');\r\n\t\tif (context) {\r\n\t\t\tparams.context = context;\r\n\t\t}\r\n\r\n\t\tthis.renderer = new THREE.WebGLRenderer(params);\r\n\t\tconsole.log(\r\n\t\t\t`[Graphic] isWebGL2Enabled : ${this.renderer.capabilities.isWebGL2}`\r\n\t\t);\r\n\t}\r\n\r\n\tsetSize(width: number, height: number) {\r\n\t\tconst camera = this.cameraComponent.getCamera();\r\n\t\tcamera.aspect = width / height;\r\n\t\tcamera.updateProjectionMatrix();\r\n\t\tthis.renderer?.setSize(width, height, false);\r\n\t}\r\n\r\n\t/**\r\n\t * 장면을 렌더링합니다.\r\n\t * @param param\r\n\t */\r\n\trender(param: RenderParam) {\r\n\t\tif (this.renderer) {\r\n\t\t\tthis.camera.matrixAutoUpdate = false;\r\n\r\n\t\t\t// prettier-ignore\r\n\t\t\tthis.camera.matrixWorld.set(\r\n\t\t\t\tparam.civm[ 0], param.civm[ 4], param.civm[ 8], param.civm[12],\r\n\t\t\t\tparam.civm[ 1], param.civm[ 5], param.civm[ 9], param.civm[13],\r\n\t\t\t\tparam.civm[ 2], param.civm[ 6], param.civm[10], param.civm[14],\r\n\t\t\t\tparam.civm[ 3], param.civm[ 7], param.civm[11], param.civm[15]\r\n\t\t\t);\r\n\t\t\t// prettier-ignore\r\n\t\t\tthis.camera.matrixWorldInverse.set(\r\n\t\t\t\tparam.cvm[ 0], param.cvm[ 4], param.cvm[ 8], param.cvm[12],\r\n\t\t\t\tparam.cvm[ 1], param.cvm[ 5], param.cvm[ 9], param.cvm[13],\r\n\t\t\t\tparam.cvm[ 2], param.cvm[ 6], param.cvm[10], param.cvm[14],\r\n\t\t\t\tparam.cvm[ 3], param.cvm[ 7], param.cvm[11], param.cvm[15]\r\n\t\t\t);\r\n\r\n\t\t\tthis.camera.updateProjectionMatrix();\r\n\r\n\t\t\tthis.renderer.render(this.scene, this.camera);\r\n\t\t}\r\n\t}\r\n}\r\n","import { PerspectiveCamera } from 'three';\r\nimport { Matrix4 } from 'cesium';\r\n\r\nexport default class CameraComponent {\r\n\tprivate static instance: CameraComponent;\r\n\tprivate readonly perspectiveCamera: PerspectiveCamera;\r\n\tprivate constructor() {\r\n\t\tthis.perspectiveCamera = new PerspectiveCamera();\r\n\t}\r\n\r\n\tgetCamera(): PerspectiveCamera {\r\n\t\treturn this.perspectiveCamera;\r\n\t}\r\n\r\n\tstatic getInstance() {\r\n\t\treturn this.instance || (this.instance = new this());\r\n\t}\r\n}\r\n","import { Subject } from 'rxjs';\r\nimport { GraphicComponent, RenderParam } from './graphic/graphic.component';\r\n\r\n/**\r\n * Cesium 과 three.js 의 스레드 간 렌더 비동기 이슈를 해결합니다.\r\n */\r\nexport class RenderQueue {\r\n\tprivate readonly _queue: RenderParam[] = [];\r\n\tprivate readonly graphic = GraphicComponent.getInstance();\r\n\tprivate param: RenderParam | undefined;\r\n\tprivate _handle: number | undefined;\r\n\tprivate readonly _bindRenderNextAnimationFrame =\r\n\t\tthis._renderNextAnimationFrame.bind(this);\r\n\tprivate readonly _renderSubject = new Subject<void>();\r\n\treadonly renderNextFrame$ = this._renderSubject.pipe();\r\n\r\n\t/**\r\n\t * 다음 장면을 그립니다.\r\n\t */\r\n\tprivate _renderNextAnimationFrame() {\r\n\t\tthis.param = this._queue.pop();\r\n\t\tif (this.param) {\r\n\t\t\tthis.graphic.render(this.param);\r\n\t\t}\r\n\t\tthis._handle = requestAnimationFrame(\r\n\t\t\tthis._bindRenderNextAnimationFrame\r\n\t\t);\r\n\t\tthis._renderSubject.next();\r\n\t}\r\n\r\n\t/**\r\n\t * 다음 장면을 요청합니다.\r\n\t * @param param 렌더링 파라미터\r\n\t */\r\n\tupdateNextAnimationFrame(param: RenderParam) {\r\n\t\tif (this._queue.length) {\r\n\t\t\tthis._queue[0] = param;\r\n\t\t} else {\r\n\t\t\tthis._queue.push(param);\r\n\t\t}\r\n\r\n\t\tif (!this._handle) this._renderNextAnimationFrame();\r\n\t}\r\n}\r\n"],"names":[],"version":3,"file":"core-thread.1f18482a.js.map","sourceRoot":"../"}